<!-- Header with Create Group button -->
<ion-header>
  <ion-toolbar>
    <ion-title>My Groups</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Create Group Button -->
  <ion-button expand="block" (click)="toggleCreateForm()" class="create-group-btn">
    <ion-icon slot="start" name="add-outline"></ion-icon>
    {{ showCreateForm ? 'Cancel' : 'Create New Group' }}
  </ion-button>

  <!-- Create Group Form -->
  <ion-card class="create-group-card" *ngIf="showCreateForm">
    <ion-card-header>
      <ion-card-title>Create Your Group</ion-card-title>
      <ion-card-subtitle>Set up your prediction group</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <form [formGroup]="groupForm" (ngSubmit)="onCreateGroup()">
        <!-- Group Type Selection -->
        <div class="group-type-selection">
          <ion-segment formControlName="type" (ionChange)="onGroupTypeChange()">
            <ion-segment-button value="casual">
              <ion-label>
                <div class="segment-content">
                  <ion-icon name="trophy-outline"></ion-icon>
                  <div class="segment-text">
                    <h3>Casual Group</h3>
                    <p>Play for bragging rights</p>
                  </div>
                </div>
              </ion-label>
            </ion-segment-button>

            <ion-segment-button value="prize">
              <ion-label>
                <div class="segment-content">
                  <ion-icon name="cash-outline"></ion-icon>
                  <div class="segment-text">
                    <h3>Prize Group</h3>
                    <p>Play for cash prizes</p>
                  </div>
                </div>
              </ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <!-- Entry Fee Selection -->
        <div class="entry-fee-section" *ngIf="groupForm.get('type')?.value === 'prize'">
          <ion-item lines="none">
            <ion-label position="stacked">Entry Fee</ion-label>

            <div class="fee-selector">
              <!-- Range Slider -->
              <div class="range-container">
                <ion-range class="fee-range" [min]="1" [max]="100" [step]="1" [pin]="true" [ticks]="true" [snaps]="true"
                  formControlName="entryFee" (ionChange)="onEntryFeeChange($event)">
                  <div slot="start" class="range-label">£1</div>
                  <div slot="end" class="range-label">£100</div>
                </ion-range>
              </div>

              <!-- Manual Input -->
              <div class="manual-fee-input">
                <div class="currency-symbol">£</div>
                <ion-input type="number" [min]="1" [max]="100" formControlName="entryFee"
                  (ionInput)="onManualFeeInput($event)" class="fee-input" clearInput="true" placeholder="0">
                </ion-input>
              </div>
            </div>

            <ion-note>Set entry fee between £1 and £100</ion-note>
          </ion-item>

          <div class="prize-breakdown" *ngIf="groupForm.get('type')?.value === 'prize'">
            <h4>Prize Breakdown</h4>

            <!-- Show this when entry fee is set -->
            <div class="prize-distribution" *ngIf="groupForm.get('entryFee')?.value">
              <div class="current-pool">
                <p>Entry Fee: {{ groupForm.get('entryFee')?.value | currency:'GBP' }}</p>
                <p>Current Members: {{ currentMemberCount }}</p>
                <p class="pool-total">Potential Prize Pool: {{ calculateTotalPool() | currency:'GBP' }}</p>
              </div>

              <div class="prize-items">
                <div class="prize-item">
                  <ion-badge color="gold">1st</ion-badge>
                  <span>{{ calculatePrize(1) | currency:'GBP' }}</span>
                </div>
                <div class="prize-item">
                  <ion-badge color="silver">2nd</ion-badge>
                  <span>{{ calculatePrize(2) | currency:'GBP' }}</span>
                </div>
                <div class="prize-item">
                  <ion-badge color="bronze">3rd</ion-badge>
                  <span>{{ calculatePrize(3) | currency:'GBP' }}</span>
                </div>
              </div>

              <div class="prize-note">
                <ion-note>* Prize amounts will be finalized once all members have joined and paid</ion-note>
              </div>
            </div>

            <!-- Show this when no entry fee is set -->
            <div class="prize-info" *ngIf="!groupForm.get('entryFee')?.value">
              <p>Set an entry fee (£1 - £100) to see potential prize distribution</p>
              <p>Prize breakdown adjusts based on number of members:</p>
              <ul class="breakdown-list">
                <li>3-5 members: Winner takes all</li>
                <li>6-10 members: 1st (70%), 2nd (30%)</li>
                <li>11-20 members: 1st (50%), 2nd (30%), 3rd (20%)</li>
                <li>21+ members: 1st (45%), 2nd (35%), 3rd (20%)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Group Name -->
        <ion-item class="group-name-input">
          <ion-label position="stacked">Group Name</ion-label>
          <ion-input formControlName="name" placeholder="Enter a memorable name for your group"
            [clearInput]="true"></ion-input>
        </ion-item>

        <div class="form-actions">
          <ion-button expand="block" type="submit" [disabled]="!groupForm.valid || isLoading" class="create-button">
            <ion-spinner *ngIf="isLoading"></ion-spinner>
            <span *ngIf="!isLoading">
              <ion-icon name="add-circle-outline"></ion-icon>
              Create Group
            </span>
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Welcome Message - Only show if no groups -->
  <ion-card *ngIf="groups.length === 0">
    <ion-card-header>
      <ion-card-title>Welcome to Group Admin</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>
        You haven't created any groups yet. Click the "Create Group" button above to get started!
      </p>
    </ion-card-content>
  </ion-card>

  <!-- Existing Groups List -->
  <ion-card *ngIf="groups.length > 0">
    <ion-card-header>
      <ion-card-title>My Groups</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="group-list-item" *ngFor="let group of groups">
        <!-- Group Name and Type -->
        <div class="group-info">
          <h2>{{ group.name }}</h2>
          <ion-badge [color]="group.type === 'prize' ? 'primary' : 'medium'" class="group-type-badge">
            {{ group.type === 'prize' ? 'Prize Group' : 'Casual Group' }}
          </ion-badge>
        </div>

        <!-- Group Details -->
        <div class="group-meta">
          <span>
            <ion-icon name="person-outline"></ion-icon>
            Admin: {{ group.adminName }}
          </span>
          <span>
            <ion-icon name="calendar-outline"></ion-icon>
            Created: {{ group.createdAt | date:'medium' }}
          </span>
          <span *ngIf="group.type === 'prize'">
            <ion-icon name="cash-outline"></ion-icon>
            Entry Fee: {{ group.entryFee | currency:'GBP' }}
          </span>
        </div>

        <!-- Group Code and Stats -->
        <div class="group-stats">
          <div class="group-code">
            <span>Group Code: {{ group.code }}</span>
            <ion-button fill="clear" (click)="copyGroupCode(group.code)">
              <ion-icon name="copy-outline"></ion-icon>
            </ion-button>
          </div>
          <div class="member-stats">
            <span>
              <ion-icon name="people-outline"></ion-icon>
              {{ group.memberCount }} Members
            </span>
            <span *ngIf="group.type === 'prize'">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              {{ group.paidMembers }}/{{ group.memberCount }} Paid
            </span>
          </div>
        </div>

        <!-- Group Actions -->
        <div class="group-actions">
          <ion-button fill="clear" (click)="showGroupDetails(group)">
            <ion-icon slot="start" name="eye-outline"></ion-icon>
            VIEW
          </ion-button>
          <ion-button fill="clear" color="danger" (click)="deleteGroup(group)">
            <ion-icon slot="start" name="trash-outline"></ion-icon>
            DELETE
          </ion-button>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Group Details Modal -->
  <ion-modal [isOpen]="!!selectedGroup" (didDismiss)="selectedGroup = null">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ selectedGroup?.name }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="selectedGroup = null">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
        <ion-toolbar>
          <ion-segment [(ngModel)]="selectedTab">
            <ion-segment-button value="members">
              <ion-icon name="people-outline"></ion-icon>
              <ion-label>Members</ion-label>
            </ion-segment-button>
            <ion-segment-button value="settings">
              <ion-icon name="settings-outline"></ion-icon>
              <ion-label>Settings</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <!-- Members Tab -->
        <div *ngIf="selectedTab === 'members'">
          <ion-searchbar
            placeholder="Search members"
            [(ngModel)]="searchTerm"
            (ionInput)="filterMembers()"
          ></ion-searchbar>

          <ion-list>
            <ion-item *ngFor="let member of filteredMembers">
              <ion-label>
                <h2>{{ member.name }}</h2>
                <p>{{ member.email }}</p>
                <p>Joined: {{ member.joinedAt | date }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>

        <!-- Settings Tab -->
        <div *ngIf="selectedTab === 'settings'">
          <ion-list>
            <ion-item>
              <ion-label>Allow Player Invites</ion-label>
              <ion-toggle [(ngModel)]="selectedGroup!.settings.allowPlayerInvites"></ion-toggle>
            </ion-item>
            <ion-item>
              <ion-label>Auto-approve Joins</ion-label>
              <ion-toggle [(ngModel)]="selectedGroup!.settings.autoApproveJoins"></ion-toggle>
            </ion-item>
            <ion-item>
              <ion-label>Show Leaderboard</ion-label>
              <ion-toggle [(ngModel)]="selectedGroup!.settings.showLeaderboard"></ion-toggle>
            </ion-item>
            <ion-item>
              <ion-label>Allow Member Chat</ion-label>
              <ion-toggle [(ngModel)]="selectedGroup!.settings.allowMemberChat"></ion-toggle>
            </ion-item>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>