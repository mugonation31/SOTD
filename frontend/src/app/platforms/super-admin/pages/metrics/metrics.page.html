<ion-header>
  <ion-toolbar>
    <ion-title>System Metrics</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="refreshMetrics($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- System Health Monitoring -->
  <div class="system-health-section ion-padding">
    <ion-card>
      <ion-card-header>
        <ion-card-title>System Health & Performance</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="health-grid">
          <!-- Platform Status -->
          <div class="health-card">
            <div class="health-icon">
              <ion-icon name="server-outline" [color]="getSystemHealthStatusColor(systemHealth.platform.status)"></ion-icon>
            </div>
            <div class="health-info">
              <h3>Platform Status</h3>
              <p>{{ systemHealth.platform.uptime }}% Uptime</p>
              <ion-badge [color]="getSystemHealthStatusColor(systemHealth.platform.status)">
                {{ systemHealth.platform.status | titlecase }}
              </ion-badge>
              <p class="health-detail" *ngIf="systemHealth.platform.lastOutage">
                Last outage: {{ getTimeAgo(systemHealth.platform.lastOutage) }}
              </p>
            </div>
          </div>

          <!-- Performance Metrics -->
          <div class="health-card">
            <div class="health-icon">
              <ion-icon name="speedometer-outline" color="primary"></ion-icon>
            </div>
            <div class="health-info">
              <h3>Performance</h3>
              <p>{{ systemHealth.performance.avgResponseTime }}ms avg</p>
              <p>{{ systemHealth.performance.errorRate }}% error rate</p>
              <ion-badge color="secondary">
                {{ systemHealth.performance.activeConnections }} active
              </ion-badge>
            </div>
          </div>

          <!-- Data Sync Status -->
          <div class="health-card">
            <div class="health-icon">
              <ion-icon name="sync-outline" [color]="getApiSyncStatusColor(systemHealth.dataSync.footballApiStatus)"></ion-icon>
            </div>
            <div class="health-info">
              <h3>Data Sync</h3>
              <p>Football API</p>
              <ion-badge [color]="getApiSyncStatusColor(systemHealth.dataSync.footballApiStatus)">
                {{ systemHealth.dataSync.footballApiStatus | titlecase }}
              </ion-badge>
              <p class="health-detail">
                Last sync: {{ getTimeAgo(systemHealth.dataSync.lastSync) }}
              </p>
              <p class="health-detail">
                Next sync: {{ getTimeUntil(systemHealth.dataSync.nextSync) }}
              </p>
            </div>
          </div>

          <!-- Security Status -->
          <div class="health-card">
            <div class="health-icon">
              <ion-icon name="shield-outline" [color]="systemHealth.security.vulnerabilities > 0 ? 'danger' : 'success'"></ion-icon>
            </div>
            <div class="health-info">
              <h3>Security</h3>
              <p>{{ systemHealth.security.failedLogins }} failed logins</p>
              <p>{{ systemHealth.security.suspiciousActivity }} suspicious activities</p>
              <ion-badge [color]="systemHealth.security.vulnerabilities > 0 ? 'danger' : 'success'">
                {{ systemHealth.security.vulnerabilities }} vulnerabilities
              </ion-badge>
              <p class="health-detail">
                Last scan: {{ getTimeAgo(systemHealth.security.lastSecurityScan) }}
              </p>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Performance Overview -->
  <div class="metrics-grid ion-padding">
    <ion-card class="metric-card predictions-enhanced">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="football-outline"></ion-icon>
          Football Predictions Analytics
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Primary Metrics -->
        <div class="predictions-primary">
          <div class="metric-item">
            <span class="label">Total Predictions</span>
            <span class="value">{{ getPredictionsValue('total') }}</span>
          </div>
          <div class="metric-item">
            <span class="label">Today's Predictions</span>
            <span class="value">{{ getPredictionsValue('today') }}</span>
          </div>
          <div class="metric-item">
            <span class="label">Accuracy Rate</span>
            <span class="value success">
              {{ getPredictionsValue('accuracy') }}%
            </span>
          </div>
        </div>

        <!-- Football-Specific Metrics -->
        <div class="predictions-football">
          <div class="metric-group">
            <h4>Gameweek Performance</h4>
            <div class="metric-item">
              <span class="label">Current Gameweek</span>
              <span class="value">{{ footballMetrics.currentGameweek }}</span>
            </div>
            <div class="metric-item">
              <span class="label">Completion Rate</span>
              <span class="value" [class.warning]="footballMetrics.completionRate < 70">
                {{ footballMetrics.completionRate }}%
              </span>
            </div>
            <div class="metric-item">
              <span class="label">Avg per User</span>
              <span class="value">{{ footballMetrics.avgPredictionsPerUser }}</span>
            </div>
          </div>

          <div class="metric-group">
            <h4>Engagement Trends</h4>
            <div class="metric-item">
              <span class="label">Peak Submission Time</span>
              <span class="value">{{ footballMetrics.peakSubmissionTime }}</span>
            </div>
            <div class="metric-item">
              <span class="label">Last Minute Submissions</span>
              <span class="value">{{ footballMetrics.lastMinuteSubmissions }}%</span>
            </div>
            <div class="metric-item">
              <span class="label">Early Submissions</span>
              <span class="value">{{ footballMetrics.earlySubmissions }}%</span>
            </div>
          </div>

          <div class="metric-group">
            <h4>Popular Predictions</h4>
            <div class="popular-outcomes">
              <div class="outcome-item" *ngFor="let outcome of footballMetrics.popularOutcomes">
                <span class="outcome-label">{{ outcome.label }}</span>
                <div class="outcome-bar">
                  <div class="outcome-fill" [style.width.%]="outcome.percentage"></div>
                </div>
                <span class="outcome-percentage">{{ outcome.percentage }}%</span>
              </div>
            </div>
          </div>

          <div class="metric-group">
            <h4>Joker Usage</h4>
            <div class="joker-stats">
              <div class="metric-item">
                <span class="label">First Joker Used</span>
                <span class="value">{{ footballMetrics.jokerUsage.firstJokerUsed }}/{{ footballMetrics.jokerUsage.totalEligible }}</span>
              </div>
              <div class="metric-item">
                <span class="label">Second Joker Used</span>
                <span class="value">{{ footballMetrics.jokerUsage.secondJokerUsed }}/{{ footballMetrics.jokerUsage.totalEligible }}</span>
              </div>
              <div class="metric-item">
                <span class="label">Optimal Usage Rate</span>
                <span class="value" [class.success]="footballMetrics.jokerUsage.optimalUsageRate > 75">
                  {{ footballMetrics.jokerUsage.optimalUsageRate }}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="metric-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="server-outline"></ion-icon>
          Storage Status
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="storage-usage">
          <div class="usage-bar">
            <ion-progress-bar [value]="storageUsagePercentage / 100" [color]="storageUsageColor">
            </ion-progress-bar>
          </div>
          <div class="usage-text">
            {{ formatBytes(metrics?.storage?.usedSpace || 0) }} /
            {{ formatBytes(metrics?.storage?.totalSize || 0) }}
          </div>
        </div>
        <div class="backup-status">
          <span class="label">Last Backup</span>
          <span class="value">
            <ion-badge [color]="getBackupStatusColor()">
              {{ metrics?.storage?.backupStatus || 'N/A' }}
            </ion-badge>
            {{ metrics?.storage?.lastBackup | date:'medium' }}
          </span>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Time Series Data -->
  <div class="metrics-history ion-padding-horizontal">
    <ion-segment [(ngModel)]="selectedTimeframe" (ionChange)="loadHistoricalData()">
      <ion-segment-button value="day">
        <ion-label>24 Hours</ion-label>
      </ion-segment-button>
      <ion-segment-button value="week">
        <ion-label>7 Days</ion-label>
      </ion-segment-button>
      <ion-segment-button value="month">
        <ion-label>30 Days</ion-label>
      </ion-segment-button>
    </ion-segment>

    <ion-card class="chart-card">
      <ion-card-content>
        <!-- TODO: Add chart visualization here -->
        <div class="chart-placeholder">
          Chart visualization will be implemented with a charting library
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>