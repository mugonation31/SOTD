<ion-header>
  <ion-toolbar>
    <div class="logo-container" (click)="navigateToWelcome()">
      <ion-icon name="football-outline" class="football-icon"></ion-icon>
      <div class="logo-text">
        <span class="logo-sotd">SOTD</span>
        <span class="logo-subtitle">Predict 3</span>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card class="auth-card">
    <ion-card-content>
      <div class="auth-header">
        <h1>Create Account</h1>
        <p>Join us and start predicting matches</p>
      </div>

      <form (ngSubmit)="onSignup()">
        <ion-list class="auth-form">
          
          <!-- Role Selection - only show if not forced -->
          <ion-item *ngIf="!isRoleForced">
            <ion-select 
              placeholder="Select Account Type" 
              [(ngModel)]="signupData.role"
              name="role" 
              required>
              <ion-select-option value="player">Player - Join prediction groups</ion-select-option>
              <ion-select-option value="group-admin">Group Admin - Create and manage groups</ion-select-option>
            </ion-select>
          </ion-item>



          <ion-item>
            <ion-input placeholder="Username" [(ngModel)]="signupData.username"
              (ionInput)="validateRequired('username', signupData.username)"
              [class.ion-invalid]="validationErrors.username" name="username" required type="text">
            </ion-input>
            <ion-note slot="error" *ngIf="validationErrors.username">
              {{ validationErrors.username }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-input placeholder="First Name" [(ngModel)]="signupData.firstName"
              (ionInput)="validateRequired('firstName', signupData.firstName)"
              [class.ion-invalid]="validationErrors.firstName" name="firstName" required type="text">
            </ion-input>
            <ion-note slot="error" *ngIf="validationErrors.firstName">
              {{ validationErrors.firstName }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-input placeholder="Last Name" [(ngModel)]="signupData.lastName"
              (ionBlur)="validateRequired('lastName', signupData.lastName)"
              [class.ion-invalid]="validationErrors.lastName" name="lastName" required type="text">
            </ion-input>
            <ion-note slot="error" *ngIf="validationErrors.lastName">
              {{ validationErrors.lastName }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-input placeholder="Email" [(ngModel)]="signupData.email" (ionInput)="validateEmail()"
              [class.ion-invalid]="validationErrors.email" name="email" required type="email">
            </ion-input>
            <ion-note slot="error" *ngIf="validationErrors.email">
              {{ validationErrors.email }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-input placeholder="Password" [(ngModel)]="signupData.password" (ionInput)="validatePassword()"
              [class.ion-invalid]="validationErrors.password" [type]="showPassword ? 'text' : 'password'"
              name="password" required>
            </ion-input>
            <ion-button fill="clear" slot="end" (click)="togglePasswordVisibility()">
              <ion-icon [name]="showPassword ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
            <ion-note slot="error" *ngIf="validationErrors.password">
              {{ validationErrors.password }}
            </ion-note>
          </ion-item>

          <div class="password-requirements" *ngIf="signupData.password.length > 0">
            <div [class.valid]="passwordCriteria.length">
              <ion-icon [name]="passwordCriteria.length ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
              Minimum 8 characters
            </div>
            <div [class.valid]="passwordCriteria.uppercase">
              <ion-icon [name]="passwordCriteria.uppercase ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
              At least one uppercase letter
            </div>
            <div [class.valid]="passwordCriteria.number">
              <ion-icon [name]="passwordCriteria.number ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
              At least one number
            </div>
            <div [class.valid]="passwordCriteria.special">
              <ion-icon [name]="passwordCriteria.special ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
              At least one special character
            </div>
          </div>

          <ion-item>
            <ion-input placeholder="Confirm Password" [(ngModel)]="signupData.confirmPassword"
              [type]="showConfirmPassword ? 'text' : 'password'" [class.ion-invalid]="validationErrors.confirmPassword"
              (ionInput)="validateConfirmPassword()" name="confirmPassword" required>
            </ion-input>
            <ion-button fill="clear" slot="end" (click)="toggleConfirmPasswordVisibility()">
              <ion-icon [name]="showConfirmPassword ? 'eye-off' : 'eye'"></ion-icon>
            </ion-button>
            <ion-note slot="error" *ngIf="validationErrors.confirmPassword">
              {{ validationErrors.confirmPassword }}
            </ion-note>
          </ion-item>
        </ion-list>

        <!-- Terms and Conditions -->
        <div class="terms-section">
          <div class="terms-container">
            <ion-checkbox 
              [(ngModel)]="signupData.acceptedTerms" 
              name="acceptedTerms"
              (ionChange)="validateAcceptedTerms()">
            </ion-checkbox>
            <div class="terms-text">
              <span>I agree to the <a href="#" (click)="openTerms($event)">Terms and Conditions</a> and <a href="#" (click)="openPrivacy($event)">Privacy Policy</a></span>
            </div>
          </div>
          <ion-note *ngIf="validationErrors.acceptedTerms" color="danger" class="terms-error">
            {{ validationErrors.acceptedTerms }}
          </ion-note>
        </div>

        <div class="auth-actions">
          <ion-button expand="block" type="submit" [disabled]="!canSubmit || isLoading">
            <span *ngIf="!isLoading">Create Account</span>
            <span *ngIf="isLoading">Creating Account...</span>
          </ion-button>
          
          <!-- Debug button to enable Supabase for testing -->
          <ion-button expand="block" fill="outline" color="warning" (click)="enableSupabaseForTesting()" style="margin-top: 10px;">
            ðŸ”§ Enable Supabase for Testing
          </ion-button>
        </div>

        <div class="auth-footer">
          <div class="auth-link">
            <ion-text color="medium">
              Already have an account?
              <a routerLink="/auth/login">Login</a>
            </ion-text>
          </div>
        </div>
      </form>
    </ion-card-content>
  </ion-card>
</ion-content>