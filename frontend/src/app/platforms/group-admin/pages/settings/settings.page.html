<ion-header>
  <ion-toolbar>
    <ion-title>Settings</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-segment [(ngModel)]="activeTab" class="ion-margin-bottom">
    <ion-segment-button value="profile">
      <ion-icon name="person-circle-outline"></ion-icon>
      <ion-label>Profile</ion-label>
    </ion-segment-button>
    <ion-segment-button value="settings">
      <ion-icon name="settings-outline"></ion-icon>
      <ion-label>Settings</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Profile Tab -->
  <div *ngIf="activeTab === 'profile'">
    <ion-card>
      <ion-card-content>
        <!-- Profile Picture (Centered) -->
        <div class="profile-picture-section">
          <div class="profile-picture-container">
            <div class="profile-picture">
              <ng-container *ngIf="profilePicture; else defaultProfileIcon">
                <img [src]="profilePicture" alt="Profile Picture" />
              </ng-container>
              <ng-template #defaultProfileIcon>
                <ion-icon
                  name="person-outline"
                  class="default-profile-icon"
                ></ion-icon>
              </ng-template>
            </div>
            <div class="camera-icon" (click)="fileInput.click()">
              <ion-icon name="camera-outline"></ion-icon>
            </div>
            <input
              #fileInput
              type="file"
              accept="image/*"
              (change)="onFileSelected($event)"
              style="display: none"
            />
          </div>
        </div>

        <!-- Profile Information (Left-aligned) -->
        <div class="profile-info-section">
          <ion-item>
            <ion-label position="stacked">Name</ion-label>
            <ion-input
              [(ngModel)]="profile.name"
              placeholder="Your name"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Email</ion-label>
            <ion-input
              [(ngModel)]="profile.email"
              type="email"
              readonly
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Phone</ion-label>
            <ion-input
              [(ngModel)]="profile.phone"
              type="tel"
              placeholder="Your phone number"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Role</ion-label>
            <ion-input [(ngModel)]="profile.role" readonly></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Joined Date</ion-label>
            <ion-input
              [(ngModel)]="profile.joinedDate"
              readonly
            ></ion-input>
          </ion-item>

          <ion-button
            expand="block"
            (click)="updateProfile()"
            class="ion-margin-top"
          >
            Update Profile
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="key-outline"></ion-icon>
          Change Password
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="form-section">
          <ion-item>
            <ion-label position="stacked">Current Password</ion-label>
            <ion-input
              type="password"
              [(ngModel)]="passwordForm.current"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">New Password</ion-label>
            <ion-input
              type="password"
              [(ngModel)]="passwordForm.new"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Confirm New Password</ion-label>
            <ion-input
              type="password"
              [(ngModel)]="passwordForm.confirm"
            ></ion-input>
          </ion-item>

          <ion-button
            expand="block"
            (click)="changePassword()"
            class="ion-margin-top"
          >
            Change Password
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-button
      expand="block"
      color="danger"
      (click)="logout()"
      class="ion-margin-top"
    >
      <ion-icon name="log-out-outline" slot="start"></ion-icon>
      Logout
    </ion-button>
  </div>

  <!-- Settings Tab -->
  <div *ngIf="activeTab === 'settings'">
    <!-- Group Settings -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="people-outline"></ion-icon>
          Group Settings
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Group Visibility</ion-label>
          <ion-select [(ngModel)]="groupSettings.visibility">
            <ion-select-option value="public"
              >Public (Searchable)</ion-select-option
            >
            <ion-select-option value="private"
              >Private (Code Only)</ion-select-option
            >
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label>Show Leaderboard</ion-label>
          <ion-toggle
            [(ngModel)]="groupSettings.showLeaderboard"
          ></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label>Enable Group Chat</ion-label>
          <ion-toggle
            [(ngModel)]="groupSettings.enableGroupChat"
          ></ion-toggle>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Prediction Settings -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="football-outline"></ion-icon>
          Prediction Settings
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Points Distribution</ion-label>
          <ion-select
            [(ngModel)]="groupSettings.pointsSystem"
            (ionChange)="onPointsSystemChange()"
          >
            <ion-select-option value="standard"
              >Standard (60-30-10)</ion-select-option
            >
            <ion-select-option value="custom"
              >Custom Split</ion-select-option
            >
          </ion-select>
        </ion-item>

        <div
          *ngIf="groupSettings.pointsSystem === 'custom'"
          class="custom-points"
        >
          <ion-item>
            <ion-label position="stacked">Correct Score (%)</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="groupSettings.customPoints.correctScore"
              min="0"
              max="100"
              (ionChange)="validatePointsTotal()"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Correct Result (%)</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="groupSettings.customPoints.correctResult"
              min="0"
              max="100"
              (ionChange)="validatePointsTotal()"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Participation (%)</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="groupSettings.customPoints.participation"
              min="0"
              max="100"
              (ionChange)="validatePointsTotal()"
            ></ion-input>
          </ion-item>

          <div class="points-total">
            Total: {{ calculatePointsTotal() }}%
            <span *ngIf="calculatePointsTotal() !== 100" class="error-text">
              (Must equal 100%)
            </span>
          </div>
        </div>

        <ion-item>
          <ion-label>Joker Usage</ion-label>
          <ion-select [(ngModel)]="groupSettings.jokerRules">
            <ion-select-option value="once"
              >Once per season</ion-select-option
            >
            <ion-select-option value="twice"
              >Twice per season</ion-select-option
            >
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Notification Settings -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="notifications-outline"></ion-icon>
          Notification Preferences
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-label>Email Notifications</ion-label>
          <ion-toggle
            [(ngModel)]="
              groupSettings.notificationPreferences.emailNotifications
            "
          ></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label>Prediction Reminders</ion-label>
          <ion-toggle
            [(ngModel)]="
              groupSettings.notificationPreferences.predictionReminders
            "
          ></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label>Result Notifications</ion-label>
          <ion-toggle
            [(ngModel)]="
              groupSettings.notificationPreferences.resultNotifications
            "
          ></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label>Member Updates</ion-label>
          <ion-toggle
            [(ngModel)]="
              groupSettings.notificationPreferences.memberUpdates
            "
          ></ion-toggle>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <ion-button
      expand="block"
      (click)="saveSettings()"
      class="ion-margin-top"
    >
      Save Settings
    </ion-button>
  </div>
</ion-content>